var t=require("node-fetch"),e=require("cheerio"),r=console.error,s=function(t,e,r){this.user=t,this.max=e||20,this.order="popular"===r||"public"===r?r:"popular",this.selectors={hearts:".count",views:".views",comments:".comments",title:".item-title"},this.url="https://codepen.io/"+this.user+"/pens/"+this.order+"/grid",this.response=[],this.index=1,this.flag=!1};s.prototype.scrape=function(t){var r=this;return new Promise(function(s,n){var i=e.load(t);i("#no-pens-message").html()&&n(new Error("No more pens"));var o=[];i(".meta").each(function(t,e){var s=r.extract(i(e),"hearts"),n=r.extract(i(e),"views"),c=r.extract(i(e),"comments"),a=r.extract(i(e),"title");o.push({title:a,hearts:s,views:n,comments:c})}),o.forEach(function(t){return r.response.push(t)}),s(o)})},s.prototype.get=function(){var e=this,s=this.url+"/"+this.index;return this.index===this.max&&(this.flag=!0),this.flag?this.response:t(s).then(function(t){return t.json()}).then(function(t){return e.scrape(t.page.html).catch(r)}).then(function(t){return t||(e.flag=!0),e.index+=1,e.get()}).catch(r)},s.prototype.extract=function(t,e){var r=this.selectors[e],s=t.find(r).text();if(s){if(r===this.selectors.title)return s.replace(/\s\s+/g,"");var n=s.match(/\d+,?\d*,?\d*/)[0].replace(/,/,"").replace(/,/,"");return parseInt(n,10)}return 0},module.exports=s;
